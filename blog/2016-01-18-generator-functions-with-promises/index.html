<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">Generator functions with promises - cannoneyed</title><meta name="robots" content="index, follow"/><meta name="author" content="Siddharth Jain"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="@f0rr0"/><meta property="fb:app_id" content="532441146961582"/><meta property="og:url" content="https://yuppi.es/blog/2016-01-18-generator-functions-with-promises/"/><meta property="og:site_name" content="Yuppies"/><meta data-react-helmet="true" name="description" content="An in-depth explanation of how generator functions can be used to make complex asynchronous code simple"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Generator functions with promises - cannoneyed"/><meta data-react-helmet="true" property="og:image" content="https://yuppi.es//6f27b51f2a1be5187c043cb7423871e5.png"/><meta data-react-helmet="true" property="article:author" content="https://facebook.com/f0rr0"/><meta data-react-helmet="true" property="article:published_time" content="2016-01-18T00:00:00-08:00"/><meta data-react-helmet="true" name="twitter:description" content="An in-depth explanation of how generator functions can be used to make complex asynchronous code simple"/><meta data-react-helmet="true" name="twitter:title" content="Generator functions with promises - cannoneyed"/><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet"/><style>@import url(https://fonts.googleapis.com/css?family=Inconsolata:400,700);*{margin:0;padding:0;border:none;box-sizing:border-box}article,aside,footer,header,hgroup,nav,section,time{display:block}html{height:100%;background:#fff;color:#21232d;font-family:Inconsolata,Andale Mono,PT Mono,Courier New,monospace;font-size:18px;line-height:1.5;overflow-y:scroll}@media screen and (max-width:600px){html{font-size:16px}}body{padding:18px;padding:1rem}#react-mount,body{height:100%}main{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;min-height:100%}.content{-ms-flex:1 0 auto;flex:1 0 auto}ol,p,pre,table,ul{padding-bottom:1.125em}li ol{padding-left:1.82em}li ol,li ul{padding-bottom:0}li ul{padding-left:1em}h1,h2,h3,h4,h5,h6{padding-bottom:.37em;line-height:1.125}h1{font-size:27px;font-size:1.5rem}h2{font-size:22.5px;font-size:1.25rem}h3{font-size:19.8px;font-size:1.1rem}h4{font-size:18px;font-size:1rem}h5{font-size:14.4px;font-size:.8rem}h6{font-size:10.799px;font-size:.6rem}small{font-size:.889em}a{color:#57c7ff;display:inline-block;text-decoration:none;position:relative;cursor:pointer}a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:2px;background-color:#57c7ff;transform:scaleX(0);transform-origin:left;transition:transform .4s ease-in-out;transition-delay:.1s}a:hover:after{transform:scaleX(1);transition-delay:0s}del{text-decoration:line-through;color:#4d5068}hr{display:block;border-top:1px solid #424559;margin:1.125em 0 2em}::-moz-selection{background:#d8d8d6;color:#21232d;background-color:hsla(60,2%,84%,.996)}::selection{color:#21232d;background-color:hsla(60,2%,84%,.996)}img::-moz-selection{background-color:hsla(60,2%,84%,.5)}img::selection{background-color:hsla(60,2%,84%,.5)}.post-list time{width:6.583em}.blog-header{padding-bottom:1.125em}.blog-header h2{padding-bottom:.216em}.blog-header time{display:inline}.blog-header div{font-size:.889em}.blog-body h1,.blog-body h2,.blog-body h3,.blog-body h4,.blog-body h5,.blog-body h6{color:#f92672}.header-anchor{display:none;opacity:0;margin-left:-1em;transition:opacity .5s ease-in-out;color:inherit!important}.header-anchor:after,.header-anchor:before{display:none}.emoji{display:inline-block;box-sizing:content-box;width:18px;width:1rem;height:18px;height:1rem;vertical-align:-.15em}.post-content h1,.post-content h2,.post-content h3,.post-content h4,.post-content h5,.post-content h6{padding-bottom:.216em}.post-content h1 .header-anchor,.post-content h2 .header-anchor,.post-content h3 .header-anchor,.post-content h4 .header-anchor,.post-content h5 .header-anchor,.post-content h6 .header-anchor{display:inline}@media screen and (max-width:600px){.post-content h1 .header-anchor,.post-content h2 .header-anchor,.post-content h3 .header-anchor,.post-content h4 .header-anchor,.post-content h5 .header-anchor,.post-content h6 .header-anchor{display:none}}.post-content h1:hover .header-anchor,.post-content h2:hover .header-anchor,.post-content h3:hover .header-anchor,.post-content h4:hover .header-anchor,.post-content h5:hover .header-anchor,.post-content h6:hover .header-anchor{opacity:.9}.post-content p:last-child{padding-bottom:0}.post-content code{font-size:.889em;color:#1d1f21;background-color:#f1f1f1;font-family:Menlo,Monaco,Consolas,monospace;display:inline-block;padding:0 .5em;border-radius:5px}@media screen and (max-width:600px){.post-content code{font-size:14px}}.post-content pre code{background-color:#1d1f21;color:#c5c8c6;display:block;padding:1.266em;white-space:pre;overflow:auto;box-shadow:inset 0 1px 10px rgba(0,0,0,.3),0 1px 0 rgba(53,56,73,.4),0 -1px 0 rgba(0,0,0,.3)}.post-content blockquote{padding:1.125em 2.566em;font-style:italic;position:relative;color:#f3f99d}.post-content blockquote:before{content:"\201C";font-size:400%;left:-12px;line-height:.5;position:absolute}.post-content blockquote ol,.post-content blockquote ul{list-style-position:inside}.post-content blockquote+p{margin-top:10px}@media screen and (max-device-width:480px){.post-content blockquote{padding:1.125em 1em}.post-content blockquote:before{font-size:200%;left:-12px}}.post-content cite{display:block;padding-top:1.125em}.post-content cite:before{content:"\2014   "}.post-content figure{text-align:center;padding:1.82em 0 2.927em}.post-content figure a{display:inline;opacity:1;transition:all .4s ease-in-out}.post-content figure a:hover{opacity:.5}.post-content figure a:after,.post-content figure a:before{display:none}.post-content figure img{display:block;max-width:100%;height:auto;margin:0 auto}.post-content figure.full-width img{min-width:100%}.post-content figure a+figcaption,.post-content img+figcaption{margin:10px 0 -10px;font-size:.889em;font-style:italic}.twitter-tweet+p{padding-top:.889em}.share-icons{display:inline-block;padding:0 .5em;cursor:pointer;opacity:1;transition:opacity .4s ease-in-out}.share-icons:first-child{padding-left:0}.share-icons:hover{opacity:.7}.post-footer>ul{padding:3px 0 1.125em;margin:1em 0;line-height:1;display:block}.post-footer>ul li{display:inline-block;list-style-type:none}.post-footer>article header{color:#f92672}.post-footer>article ul li{display:block;padding-bottom:10px}.post-footer>article ul li:last-child,.post-footer>article ul li>p{padding-bottom:0}.header{padding:0 0 18px;padding:0 0 1rem}.header h1 a{font-size:22.5px;font-size:1.25rem;background:url(/6f9b9902cc49a0964908d1d20a859724.png);background-size:cover;background-position:top;background-position:20%;color:#fff;padding:0 18px;padding:0 1rem;margin-left:-18px;margin-left:-1rem}.header h1 a:after,.header h1 a:before{display:none}.header li,.header nav,.header ul{display:inline-block;line-height:27px;line-height:1.5rem;padding-bottom:0}.header li{margin:0 12px;list-style-type:none}.header li:first-child{margin-left:0}.header li:last-child{margin-right:0}footer{margin-top:36px;margin-top:2rem}footer p,footer ul{padding:29.16px 0;padding:1.62rem 0;display:inline-block}@media screen and (max-width:415px){footer p,footer ul{display:block;width:100%}}footer p{font-size:16px;float:left}footer p .footer-icon{vertical-align:-4.5px;vertical-align:-.25rem}@media screen and (max-width:415px){footer p{padding-bottom:.5rem}}@media screen and (max-width:415px){footer ul{padding-top:.5rem}}footer li{padding:0 4px;list-style-type:none;display:inline-block}@media screen and (max-width:415px){footer li{padding:0 7px}}footer a{color:#d8d8d6;opacity:.7;transition:all .4s ease-in-out}footer a:hover{opacity:1}footer a:after,footer a:before{display:none}.footer-icon{height:16px;width:16.5px;background-size:cover;background-position:0 0;filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="table" tableValues="1 0" /><feFuncG type="table" tableValues="1 0" /><feFuncB type="table" tableValues="1 0" /></feComponentTransfer><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="linear" slope="0.85" /><feFuncG type="linear" slope="0.85" /><feFuncB type="linear" slope="0.85" /></feComponentTransfer></filter></svg>#filter');filter:invert(100%) brightness(85%);display:inline-block;vertical-align:-.5px}@media screen and (max-width:415px){.footer-icon{height:16.5px;width:16.5px}}.bio{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;padding-bottom:1.125em}.bio .avatar{margin-right:1em;width:100px;border-radius:50%}.bio .intro{-ms-flex:1;flex:1;padding-bottom:0}@media screen and (max-width:600px){ol,ul{list-style-position:inside}}@media only screen and (min-device-width:320px) and (max-device-width:480px){.content a{display:inline}.content a:after,.content a:before{display:none}.bio{display:block;overflow:auto;padding-bottom:1.125em}.bio .avatar{float:left;margin-right:1em;width:80px;border-radius:50%}.bio .intro{-ms-flex:1;flex:1;padding-bottom:0}}.markdown-no-underline a:after,.markdown-no-underline a:before{display:none}.markdown-icon{width:20px;position:relative;top:5px}._3dqiAAitwjn3d1ZOaa1ruo{max-width:100%}._1bQfOnGili8krkHalN4rjB{display:flex;flex-direction:column;justify-content:center;align-items:center}._1zVObHXXe94EVlW5lsd18l{width:40rem}@media screen and (max-width:800px){._1zVObHXXe94EVlW5lsd18l{max-width:40rem;width:100%}}.ijn5YLFHnnzwMKdqZPn3O{width:400px;margin-left:-20px}.hljs-comment,.hljs-quote{color:#969896}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c66c66}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#de935f}.hljs-attribute{color:#f0c674}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#b5bd68}.hljs-section,.hljs-title{color:#81a2be}.hljs-keyword,.hljs-selector-tag{color:#b294bb}.hljs{display:block;overflow-x:auto;background:#1d1f21;color:#c5c8c6;padding:.5em}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.lists{display:-ms-flexbox;display:flex;position:relative;font-size:18px}@media screen and (max-width:767px){.lists{display:block}}.list-intro{font-size:.79em;font-family:Menlo,Monaco,Consolas,monospace;padding-bottom:1em;transition:opacity .5s ease-in}@media screen and (max-width:767px){.list-intro{letter-spacing:-.75px}}.ellipsis{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.activity-list,.track-list{-ms-flex:1 0 auto;flex:1 0 auto;margin:0;padding:0}.activity-list ul,.track-list ul{list-style-type:none!important;padding-bottom:1.5em}.track-list a:first-child .track{margin-top:0}.track-list a:last-child .track{margin-bottom:0}.activity-list .activity:first-child{margin-top:0}.activity-list .activity:last-child{margin-bottom:0}.activity-list .activity,.track-list .track{overflow:auto;overflow-x:hidden;position:relative;margin:12px 0;border-radius:3px;padding:5px;background:#2a2c3c;transition:opacity .5s ease-in,background .4s ease-in-out}.activity-list .activity .thumb,.track-list .track .thumb{width:80px;height:80px;border-radius:2px;background-size:cover;background-position:50%;background-color:#3e4256;float:left;margin-right:8px}.activity-list .activity .info,.track-list .track .info{position:absolute;top:50%;transform:translateY(-50%);padding-left:90px;padding-right:10px;width:97%}.track-list .thumb{box-shadow:inset 0 0 10px #000}.track-list .track:hover{background:#353849}.activity-list~.track-list{padding-left:2.027em}@media screen and (max-width:767px){.activity-list~.track-list{padding-left:0}}.activity-list .activity .icon{background-position:0 0;background-color:rgba(0,255,85,.01);filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="table" tableValues="1 0" /><feFuncG type="table" tableValues="1 0" /><feFuncB type="table" tableValues="1 0" /></feComponentTransfer><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="linear" slope="0.85" /><feFuncG type="linear" slope="0.85" /><feFuncB type="linear" slope="0.85" /></feComponentTransfer></filter></svg>#filter');filter:invert(100%) brightness(85%);width:60px;height:60px;margin:10px 6px 10px 14px}.activity-list .category,.track-list .title{font-size:.79em}.activity-list time,.track-list .artist{font-size:.79em;padding-bottom:7px}.activity-list .activities,.track-list time{font-size:.72em}.track-list a{display:inherit;color:inherit}.track-list a:after,.track-list a:before{display:none}.activity-list .activities{font-style:italic}.equaliser-container{margin-top:5px;margin-bottom:3px;font-size:10px;height:1em;position:relative}.equaliser-container .equaliser-column{width:2px;float:left;margin:0 1px 0 0;padding:0;height:1em;position:relative;list-style-type:none}.equaliser-container .equaliser-column .colour-bar{position:absolute;left:0;right:0;bottom:0;height:1em;background:#d8d8d6}.equaliser-container .equaliser-column:first-child .colour-bar{animation:color-bar 2s 1s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(2) .colour-bar{animation:color-bar 2s .5s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(3) .colour-bar{animation:color-bar 2s 1.5s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(4) .colour-bar{animation:color-bar 2s .25s ease-out alternate infinite}.equaliser-container .equaliser-column:nth-child(5) .colour-bar{animation:color-bar 2s 2s ease-out alternate infinite}.equaliser-container .equaliser-column:last-child{margin-right:0}@keyframes color-bar{0%{height:1em}10%{height:.3em}20%{height:.5em}30%{height:.2em}40%{height:.6em}50%{height:.8em}60%{height:.5em}70%{height:.7em}80%{height:1em}90%{height:.7em}to{height:.25em}}.loading{text-align:center;display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center;width:100%;padding-top:1.125em}.double-bounce,.loading p{display:inline-block}.double-bounce{width:27px;height:27px;margin:0 10px;position:relative}.double-bounce1,.double-bounce2{display:inline-block;width:100%;height:100%;border-radius:50%;background-color:#424559;opacity:.6;position:absolute;top:0;left:0;animation:bounce 2s infinite ease-in-out}.double-bounce2{animation-delay:-1s}@keyframes bounce{0%,to{transform:scale(0)}50%{transform:scale(1)}}.qs-appear{opacity:.01}.qs-appear.qs-appear-active{opacity:1;transition:opacity 1.2s ease-in-out}@media only screen and (min-device-width:320px) and (max-device-width:480px){.lists a{border-bottom:none}}._1zyVehNnZFTcD5l03ROJu5{margin:0 auto;max-width:1200px}._2BC8I5NaZ0YzQTyg1wNLrT{display:block;position:relative;transition:all 1s linear}._2BC8I5NaZ0YzQTyg1wNLrT>a:after{display:none}._2BC8I5NaZ0YzQTyg1wNLrT:hover{filter:brightness(155%)}._2RareCsUxGJGP09HMolV_H{max-width:100%}._1fD1yKTsBKru7REwzk6S7{position:absolute;bottom:1rem;color:#fff;width:100%;text-align:center;background-color:rgba(0,0,0,.5)}@media screen and (min-width:600px){._2kLYBmqQ-MPjQcgS1CrpYo{display:flex;flex-wrap:wrap;flex-direction:row;justify-content:space-between;margin-bottom:1rem}._2BC8I5NaZ0YzQTyg1wNLrT{width:49%;display:inline-block;text-align:center}}._2gBxEARaisSfM5iKb37psR{margin:0 auto;max-width:1200px}._2rVu9jkT3KqCQlr8qp19RQ{display:block;position:relative;transition:all 1s linear}._2rVu9jkT3KqCQlr8qp19RQ>a:after{display:none}._2rVu9jkT3KqCQlr8qp19RQ:hover{filter:brightness(155%)}._1I0ejFd0uesmdsD1dxadjC{max-width:100%}._3U3ITYTADtlW6vwydc0d5K{position:absolute;bottom:1rem;color:#fff;width:100%;text-align:center;background-color:rgba(0,0,0,.5)}@media screen and (min-width:600px){._2eO0F0mhxynkBuxAX5Wm3-{display:flex;flex-wrap:wrap;flex-direction:row;justify-content:space-between;margin-bottom:1rem}._2rVu9jkT3KqCQlr8qp19RQ{width:49%;display:inline-block;text-align:center}}</style></head><body class="container"><div id="react-mount"><div class="_1bQfOnGili8krkHalN4rjB" data-reactroot="" data-reactid="1" data-react-checksum="-1408803551"><main class="_1zVObHXXe94EVlW5lsd18l" data-reactid="2"><header class="header" data-reactid="3"><nav data-reactid="4"><ul data-reactid="5"><li data-reactid="6"><a href="/" data-reactid="7">cannoneyed</a></li><!-- react-text: 8 -->·<!-- /react-text --><li data-reactid="9"><a href="/about/" data-reactid="10">about</a></li><!-- react-text: 11 -->·<!-- /react-text --><li data-reactid="12"><a href="/blog/" data-reactid="13">blog</a></li><!-- react-text: 14 -->·<!-- /react-text --><li data-reactid="15"><a href="/projects/" data-reactid="16">projects</a></li></ul></nav></header><section class="content" data-reactid="17"><!-- react-empty: 18 --><article class="blog-body" data-reactid="19"><header class="blog-header" data-reactid="20"><h2 data-reactid="21">Generator functions with promises</h2><div data-reactid="22"><time data-reactid="23">January 18, 2016</time><!-- react-text: 24 --> <!-- /react-text --><!-- react-text: 25 -->· <!-- /react-text --><!-- react-text: 26 -->1366<!-- /react-text --><!-- react-text: 27 --> words · <!-- /react-text --><!-- react-text: 28 -->7 min read<!-- /react-text --></div></header><div class="post-content" data-reactid="29"><p>A <strong>generator function</strong> is a function that can be exited and re-entered later. It’s written just like a normal function, except it’s declared with the keyword <code>function*</code>. Notice the <code>yield</code> keywords, which can only be used inside a <strong>generator function</strong> - these are the points where code execution enters and exits the function body.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> sayHello = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">generator</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">yield</span> sayHello(<span class="hljs-string">'dog'</span>)
  <span class="hljs-keyword">yield</span> sayHello(<span class="hljs-string">'cat'</span>)
}
</code></pre>
<p>Invoking a <strong>generator function</strong> creates an <strong>iterator</strong>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> iterator = generator()
</code></pre>
<p>Iterators provide the interface for running the code inside of a generator function. By invoking the <code>next</code> method of the iterator, we can run code in the generator function in steps, with program flow entering and exiting the function body.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> message = iterator.next().value
<span class="hljs-comment">// message = 'hello, dog'</span>
message = iterator.next().value
<span class="hljs-comment">// message = 'hello, cat'</span>
</code></pre>
<p>When <code>iterator.next()</code> is invoked, the code inside of <code>generator</code> is executed up to the first <code>yield</code> statement, where the code ‘pauses’. The result of invoking <code>iterator.next()</code> is a <code>step</code> object with a <code>value</code> property, which is the value of the expression to the right of the <code>yield</code> keyword (<code>sayHello('dog')</code>, which returned <code>'hello, dog'</code>). Invoking <code>iterator.next()</code> again ‘resumes’ program flow where it left off and executes until the next yield statement. The <code>step</code> object returned by <code>next()</code> now has a <code>value</code> of <code>'hello, cat'</code>.</p>
<p>This <code>step</code> object returned by invoking <code>next</code> contains another property: <code>done</code>. The <code>done</code> property is a<code>boolean</code> and is only <code>true</code> after the <strong>generator function</strong> returns.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> saySomething = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">generator</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'dog'</span>)
  <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'cat'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-string">'fin'</span>
}

<span class="hljs-keyword">var</span> iterator = generator()
<span class="hljs-keyword">var</span> step = iterator.next() <span class="hljs-comment">// { value: 'hello, dog', done: false }</span>
step = iterator.next() <span class="hljs-comment">// { value: 'hello, cat', done: false }</span>
step = iterator.next() <span class="hljs-comment">// { value: 'fin', done: true }</span>

</code></pre>
<p>We can also pass input back into the generator function by invoking the <code>next</code> method with an argument. The value passed into the <code>next</code> method is assigned to the left of the <code>yield</code> keyword. This behavior is illustrated below.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// All together</span>
<span class="hljs-keyword">const</span> saySomething = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">generator</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'dog'</span>)
  <span class="hljs-built_in">console</span>.log(response)
  response = <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'cat'</span>)
  <span class="hljs-built_in">console</span>.log(response)
}

<span class="hljs-keyword">var</span> iterator = generator()

<span class="hljs-keyword">var</span> message
message = iterator.next(<span class="hljs-number">1</span>).value
<span class="hljs-built_in">console</span>.log(message)
message = iterator.next(<span class="hljs-number">2</span>).value
<span class="hljs-built_in">console</span>.log(message)
<span class="hljs-comment">// hello, dog</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// hello, cat</span>
<span class="hljs-comment">// 2</span>
</code></pre>
<hr>
<p>This functionality is very interesting - exiting and re-entering a function body is certainly some unique behavior. As it turns out, it’s a very useful trick in handling asynchronous code.</p>
<p>By leveraging <strong>generator functions</strong> with some clever use of <strong>Promises</strong>, we can create an elegant way to handle complex asynchronous code in a simple, readable way.</p>
<p>Let’s begin by imagining that our <code>sayHello</code> function needed to do some asynchronous work that takes some time and returns a <strong>Promise</strong>. The normal <strong>Promise</strong>-based control flow would look something like this:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> sayHello = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>).delay(<span class="hljs-number">1000</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">usePromises</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> sayHello(<span class="hljs-string">'dog'</span>)
    .then(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(message)
      <span class="hljs-keyword">return</span> sayHello(<span class="hljs-string">'cat'</span>)
    })
    .then(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(message)
    })
}

usePromises()
<span class="hljs-comment">// 0s: 'hello, dog'</span>
<span class="hljs-comment">// 1s: 'hello, cat'</span>
</code></pre>
<p>This chainable <code>.then</code> style syntax, especially when complemented with <code>bluebird</code>'s excellent helper methods, is certainly an improvement over a raw callback-based approach and libraries such as <code>async</code>, but it leaves a lot to be desired, especially when things get complicated and fairly nested <strong>Promise</strong> chain logic becomes unavoidable.</p>
<p>If we could use the es7 <code>async</code> / <code>await</code> syntax, this code would be much more elegant. However, these methods are not part of the es6 standard and require a transpilation step, which is not for everyone. Here’s what the future holds:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> sayHello = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>).delay(<span class="hljs-number">1000</span>)

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useAsyncAwait</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">await</span> sayHello(<span class="hljs-string">'dog'</span>)
  <span class="hljs-built_in">console</span>.log(message)
  message = <span class="hljs-keyword">await</span> sayHello(<span class="hljs-string">'cat'</span>)
  <span class="hljs-built_in">console</span>.log(message)
}

useAsyncAwait()
<span class="hljs-comment">// 1s: 'hello, dog'</span>
<span class="hljs-comment">// 2s: 'hello, cat'</span>
</code></pre>
<p>The <code>async</code> / <code>await</code> syntax is remarkably simple to our <strong>generator function</strong> based code from earlier - execution of code seemingly pauses in the middle of the function, waits for a <strong>Promise</strong> to resolve, then picks up where it left off. The question is, can we make <strong>generator functions</strong>  exhibit the same sort of behavior with asynchronous code?</p>
<p>It turns out that we can by using a few tricks. <code>bluebird</code>, as usual, offers an excellent implementation, but to better understand how it works and feel even more confident in our understanding, we’ll build our own.</p>
<p>Recall that a <strong>generator function</strong> returns an <strong>iterator</strong>, and that this <strong>iterator</strong> is the interface for running the code inside of the generator. Also recall that by invoking the <strong>iterator</strong>’s <code>next</code> method, code inside the generator is executed up to the <code>yield</code> statement, where it ‘pauses’ until the <code>next</code> method is invoked again.</p>
<p>Now imagine pairing our asynchronous <code>sayHello</code> function with a <strong>generator function</strong>, like below</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> sayHello = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>).delay(<span class="hljs-number">1000</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">generator</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">yield</span> sayHello(<span class="hljs-string">'dog'</span>)
  <span class="hljs-keyword">yield</span> sayHello(<span class="hljs-string">'cat'</span>)
}
</code></pre>
<p>If we create an <strong>iterator</strong> and invoke <code>next</code>, it should come as no surprise that the <code>value</code> property of the object returned by calling the <strong>iterator</strong>’s <code>next</code> method is a <strong>Promise</strong>, since that’s what <code>sayHello</code> is returning.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> message
message = iterator.next().value
<span class="hljs-comment">// message = Promise (will eventually resolve 'hello, dog')</span>
message = iterator.next().value
<span class="hljs-comment">// message = Promise (will eventually resolve 'hello, cat')</span>
</code></pre>
<p>This is the secret - Since each invocation of the <strong>iterator</strong>’s <code>next</code> method gives us a  <code>Promise</code>, we can devise a way to make the resolution of each <code>Promise</code> trigger the <code>next</code> method, resuming the code inside the <strong>generator</strong> where we left off and giving us access to the next Promise.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> saySomething = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>).delay(<span class="hljs-number">1000</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">generator</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'dog'</span>)
  <span class="hljs-built_in">console</span>.log(message)
  message = <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'cat'</span>)
  <span class="hljs-built_in">console</span>.log(message)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runGenerator</span>(<span class="hljs-params">genFn</span>) </span>{
  <span class="hljs-keyword">var</span> iterator = genFn()
  nextStep()

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nextStep</span>(<span class="hljs-params">response</span>) </span>{
    <span class="hljs-keyword">var</span> step = iterator.next(response)
    <span class="hljs-keyword">var</span> promise = step.value
    <span class="hljs-keyword">if</span> (!step.done) {
      promise.then(<span class="hljs-function"><span class="hljs-params">resolution</span> =&gt;</span> {
        nextStep(resolution)
      })
    }
  }
}

runGenerator(generator)
<span class="hljs-comment">// 1s: hello, dog</span>
<span class="hljs-comment">// 2s: hello, cat</span>
</code></pre>
<p>By wrapping our <strong>generator function</strong> with the helper function <code>runGenerator</code>, we can leverage the ability to exit and re-enter the generator function to elegantly handle asynchronous code with a very straightforward syntax.</p>
<p>Our <code>runGenerator</code> helper first creates an <strong>iterator</strong> from our <strong>generator function</strong>, then creates and invokes a function called <code>nextStep</code>. The <code>nextStep</code> function’s job is actually pretty simple, even though it looks complicated - First, call <code>next</code> on the iterator, passing in the appropriate response to be handed back to the <code>yield</code> (The first time we call <code>nextStep</code>, we don’t pass anything in, since we don’t yet have anything to give back to the generator). By calling <code>next</code> on the iterator, code is run inside the <strong>generator</strong> up to the first <code>yield</code> statement, and we receive back a <code>step</code> object with a <code>value</code> property that’s the <strong>Promise</strong> returned by <code>saySomething</code>!</p>
<p>This is the key - by adding a <code>.then</code> method to this <strong>Promise</strong>, we can define the behavior for it to perform when it resolves. What we want to do is trigger <code>nextStep</code>, but this time call it with the value resolved by the <strong>Promise</strong> (<code>'hello, dog'</code>). This <code>resolution</code> is then passed into the <code>iterator.next</code> method, which assigns it to the left of the first <code>yield</code> statement and the code restarts inside the <strong>generator</strong> unil the next <code>yield</code> is reached!</p>
<p>Notice that we have to check to make sure our <code>step</code> object isn’t done before trying to call <code>next</code> again.</p>
<p>Fortunately, <code>bluebird</code> offers a <code>coroutine</code> method for doing just this. In cases where aysnchronous code is too complex to be handled elegantly by normal <strong>Promise</strong>-based methods, <strong>generator functions</strong> invoked by a <strong>coroutine</strong> handler can offer a massive increase in code readability.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> saySomething = <span class="hljs-function">(<span class="hljs-params">what</span>) =&gt;</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">`hello, <span class="hljs-subst">${what}</span>`</span>).delay(<span class="hljs-number">1000</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">generator</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> message = <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'dog'</span>)
  <span class="hljs-built_in">console</span>.log(message)
  message = <span class="hljs-keyword">yield</span> saySomething(<span class="hljs-string">'cat'</span>)
  <span class="hljs-built_in">console</span>.log(message)
}

<span class="hljs-built_in">Promise</span>.coroutine(generator)()
<span class="hljs-comment">// 1s: hello, dog</span>
<span class="hljs-comment">// 2s: hello, cat</span>
</code></pre>
<p><strong>Promises</strong> with <strong>generator functions</strong> offer an elegant solution to the problems caused by complex asynchronous code - We can write code in a way that looks and behaves very much like normal, easy-to-read synchronous code by leveraging the ability to enter and exit the execution flow inside of a <strong>generator</strong>.</p>
</div></article></section><footer data-reactid="30"><section data-reactid="31"><p data-reactid="32"></p></section></footer></main></div></div><script async="" src="/bundle.js?t=1572911925710"></script><script async="">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-84957482-1', 'auto'); ga('send', 'pageview');</script></body></html>